name: Deploy to Droplet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        run: |
          [[ -n "${{ secrets.DO_HOST }}" ]] || { echo "DO_HOST missing"; exit 1; }
          [[ -n "${{ secrets.DO_USER }}" ]] || { echo "DO_USER missing"; exit 1; }
          [[ -n "${{ secrets.DO_SSH_KEY }}" ]] || { echo "DO_SSH_KEY missing"; exit 1; }
          echo "Secrets look ok"
      - name: SSH deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT != '' && secrets.DO_PORT || 22 }}
          script: |
            set -e
            APP_DIR=${{ secrets.APP_DIR || '/var/www/nepse-api' }}
            cd "$APP_DIR"
            ./update.sh
            pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
