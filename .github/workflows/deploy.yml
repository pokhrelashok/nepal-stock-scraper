name: Deploy to Droplet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            set -e
            APP_DIR=${{ secrets.APP_DIR || '/var/www/nepse-api' }}
            cd "$APP_DIR"
            ./update.sh
            pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
